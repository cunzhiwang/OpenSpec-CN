/**
 * 技能模板工作流模块
 *
 * 此文件是将旧版单体模板文件拆分为
 * 以工作流为中心的模块后生成的。
 */
import type { SkillTemplate } from '../types.js';

export function getFeedbackSkillTemplate(): SkillTemplate {
  return {
    name: 'feedback',
    description: '收集并提交用户关于 OpenSpec 的反馈，包含上下文丰富和匿名化处理。',
    instructions: `帮助用户提交关于 OpenSpec 的反馈。

**目标**：引导用户收集、丰富和提交反馈，同时通过匿名化确保隐私。

**流程**

1. **从对话中收集上下文**
   - 查看最近的对话历史以获取上下文
   - 识别正在执行的任务
   - 注意什么运行良好或不良
   - 捕获具体的摩擦点或表扬

2. **起草丰富的反馈**
   - 创建一个清晰、描述性的标题（单句，不需要"反馈："前缀）
   - 编写正文，包括：
     - 用户试图做什么
     - 发生了什么（好或坏）
     - 对话中的相关上下文
     - 任何具体的建议或请求

3. **匿名化敏感信息**
   - 用 \`<path>\` 或通用描述替换文件路径
   - 用 \`<redacted>\` 替换 API 密钥、令牌、秘密
   - 用 \`<company>\` 替换公司/组织名称
   - 用 \`<user>\` 替换个人姓名
   - 用 \`<url>\` 替换特定 URL，除非是公开/相关的
   - 保留有助于理解问题的技术细节

4. **展示草稿以供批准**
   - 向用户显示完整的草稿
   - 清楚地显示标题和正文
   - 在提交之前请求明确批准
   - 允许用户请求修改

5. **确认后提交**
   - 使用 \`openspec feedback\` 命令提交
   - 格式：\`openspec feedback "title" --body "body content"\`
   - 该命令将自动添加元数据（版本、平台、时间戳）

**示例草稿**

\`\`\`
标题：工件工作流中的错误处理需要改进

正文：
我在创建新变更时遇到了工件工作流的问题。当我尝试在创建提案后继续时，系统没有清楚地说明我需要先完成规范。

建议：添加更清晰的错误消息来解释工件工作流中的依赖链。
类似这样："无法创建 design.md，因为规范未完成（0/2 完成）。"

上下文：使用 spec-driven schema 与 <path>/my-project
\`\`\`

**匿名化示例**

之前：
\`\`\`
正在处理 /Users/john/mycompany/auth-service/src/oauth.ts
因 API 密钥失败：sk_live_abc123xyz
在 Acme Corp 工作
\`\`\`

之后：
\`\`\`
正在处理 <path>/oauth.ts
因 API 密钥失败：<redacted>
在 <company> 工作
\`\`\`

**护栏**

- 必须在提交前显示完整草稿
- 必须请求明确批准
- 必须匿名化敏感信息
- 允许用户在提交前修改草稿
- 未经用户确认不要提交
- 要包含相关的技术上下文
- 要保留对话特定的见解

**需要用户确认**

始终询问：
\`\`\`
这是我起草的反馈：

标题：[标题]

正文：
[正文]

看起来好吗？如果你愿意，我可以修改它，或者按原样提交。
\`\`\`

只有在用户确认后才继续提交。`,
    license: 'MIT 许可证',
    compatibility: '需要 openspec CLI。',
    metadata: { author: 'openspec', version: '1.0' },
  };
}
